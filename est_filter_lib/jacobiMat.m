function J = jacobiMat(q, ref)
    d00 = q(:,1) * ref(:,1) + q(:,4) * ref(:,2) - q(:,3) * ref(:,3);
    d01 = q(:,2) * ref(:,1) + q(:,3) * ref(:,2) + q(:,4) * ref(:,3);
    d02 = -q(:,3) * ref(:,1) + q(:,2) * ref(:,2) - q(:,1) * ref(:,3);
    d03 = -q(:,4) * ref(:,1) + q(:,1) * ref(:,2) + q(:,2) * ref(:,3);
    d10 = -q(:,4) * ref(:,1) + q(:,1) * ref(:,2) + q(:,2) * ref(:,3);
    d11 = q(:,3) * ref(:,1) - q(:,2) * ref(:,2) + q(:,1) * ref(:,3);
    d12 = q(:,2) * ref(:,1) + q(:,3) * ref(:,2) + q(:,4) * ref(:,3);
    d13 = -q(:,1) * ref(:,1) - q(:,4) * ref(:,2) + q(:,3) * ref(:,3);
    d20 = q(:,3) * ref(:,1) - q(:,2) * ref(:,2) + q(:,1) * ref(:,3);
    d21 = q(:,4) * ref(:,1) - q(:,1) * ref(:,2) - q(:,2) * ref(:,3);
    d22 = q(:,1) * ref(:,1) + q(:,4) * ref(:,2) - q(:,3) * ref(:,3);
    d23 = q(:,2) * ref(:,1) + q(:,3) * ref(:,2) + q(:,4) * ref(:,3);

    J = [d00, d01, d02, d03;
         d10, d11, d12, d13;
         d20, d21, d22, d23];
    J = 2*J;
end